<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client and Department Modification</title>
    <script>
        // Load YAML content and generate form fields
        async function loadYAML() {
            const response = await fetch('/get-input');
            if (response.ok) {
                const data = await response.json();
                generateForm(data);
            } else {
                alert("Failed to load YAML: " + (await response.json()).error);
            }
        }

        // Add new submodule dynamically
        async function addSubmodule() {
            const submoduleName = prompt("Enter submodule name:");
            const submoduleFile = prompt("Enter submodule file:");

            if (!submoduleName || !submoduleFile) return;

            const response = await fetch('/add-submodule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ submodule_name: submoduleName, submodule_file: submoduleFile })
            });

            if (response.ok) {
                alert((await response.json()).message);
                loadYAML();  // Reload the submodules only
            } else {
                alert("Failed to add submodule: " + (await response.json()).error);
            }
        }

        // Remove a submodule dynamically
        async function removeSubmodule(submoduleName) {
            const confirmRemove = confirm(`Are you sure you want to remove the submodule: ${submoduleName}?`);
            if (!confirmRemove) return;

            const response = await fetch('/remove-submodule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ submodule_name: submoduleName })
            });

            if (response.ok) {
                alert((await response.json()).message);
                loadYAML();  // Reload the submodules only
            } else {
                alert("Failed to remove submodule: " + (await response.json()).error);
            }
        }

        // Generate form dynamically for editable fields only
        function generateForm(data, parentKey = '', parentElement = null) {
            const formContainer = parentElement || document.getElementById('formContainer');
            formContainer.innerHTML = ''; // Clear existing form only for non-submodule parts

            for (const [key, value] of Object.entries(data)) {
                const div = document.createElement('div');
                div.style.marginBottom = '15px';

                if (key === 'client_name') {
                    const label = document.createElement('label');
                    label.textContent = `Client name:`;
                    label.className = 'form-label';
                    label.style.fontFamily = 'Poppins';
                    label.style.fontWeight = 'bold';

                    const valueInput = document.createElement('input');
                    valueInput.type = 'text';
                    valueInput.value = value;
                    valueInput.name = `${parentKey}${key}`;
                    valueInput.className = 'form-input';

                    div.appendChild(label);
                    div.appendChild(valueInput);
                    formContainer.appendChild(div);
                } else if (key === 'submodules') {
                    const label = document.createElement('label');
                    label.textContent = `Departments :`;
                    label.className = 'form-label';
                    label.style.fontFamily = 'Poppins';
                    label.style.fontWeight = 'bold';


                    const nestedDiv = document.createElement('div');
                    nestedDiv.style.marginLeft = '20px';

                    div.appendChild(label);
                    div.appendChild(nestedDiv);
                    generateSubmodules(value, nestedDiv); // Pass existing submodules to this function
                    formContainer.appendChild(div);

                    // Add "Add Submodule" button at the end of all submodules
                    const addButton = document.createElement('button');
                    addButton.textContent = 'Add department';
                    addButton.onclick = addSubmodule;
                    addButton.style.marginLeft = '370px';
                    nestedDiv.appendChild(addButton);
                }
            }
        }

        // Generate submodules section
        function generateSubmodules(submodules, parentElement) {
            // Create the table structure
            const table = document.createElement('table');
            table.className = 'form-table';
            table.style.marginLeft = '36px';

            // Create the table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = ['Department Name', 'Department File', '  Actions'];
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.style.paddingRight = '30px';
                th.style.backgroundColor = 'lightblue';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create the table body
            const tbody = document.createElement('tbody');
            for (const [name, file] of Object.entries(submodules)) {
                const row = document.createElement('tr');

                const nameCell = document.createElement('td');
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.value = name;
                nameInput.placeholder = 'Submodule Name';
                nameInput.className = 'form-input';
                nameCell.appendChild(nameInput);

                const fileCell = document.createElement('td');
                const fileInput = document.createElement('input');
                fileInput.type = 'text';
                fileInput.value = file;
                fileInput.placeholder = 'Submodule File';
                fileInput.className = 'form-input';
                fileCell.appendChild(fileInput);

                const actionsCell = document.createElement('td');
                const removeButton = document.createElement('button');
                removeButton.textContent = 'Remove';
                removeButton.onclick = () => removeSubmodule(name);

                // Make the button smaller and give it a red color
                removeButton.style.fontSize = '12px';  // Adjust the font size to make it smaller
                removeButton.style.padding = '5px 20px';  // Adjust padding for a smaller button
                removeButton.style.backgroundColor = 'red';  // Set background color to red
                removeButton.style.color = 'white';  // Set text color to white
                removeButton.style.border = 'none';  // Remove border (optional)
                removeButton.style.borderRadius = '5px';  // Optional: rounded corners
                removeButton.style.cursor = 'pointer';  // Change cursor on hover
                removeButton.style.width = '80px';

                actionsCell.appendChild(removeButton);


                // Append cells to the row
                row.appendChild(nameCell);
                row.appendChild(fileCell);
                row.appendChild(actionsCell);

                // Append row to the table body
                tbody.appendChild(row);
            }

            table.appendChild(tbody);
            parentElement.appendChild(table);
        }


        function getFormData(container) {
            const result = { submodules: {} };

            // Find all rows in the table (which represent submodules)
            const rows = container.querySelectorAll('table tbody tr');

            rows.forEach(row => {
                const nameInput = row.querySelector('td input[placeholder="Submodule Name"]');
                const fileInput = row.querySelector('td input[placeholder="Submodule File"]');

                // Ensure both inputs exist and have values
                if (nameInput && fileInput) {
                    const submoduleName = nameInput.value;
                    const submoduleFile = fileInput.value;
                    result.submodules[submoduleName] = submoduleFile;
                }
            });

            // Find and add the client name input
            const clientNameInput = container.querySelector('input[name="client_name"]');
            if (clientNameInput) {
                result.client_name = clientNameInput.value;
            }

            return result;
        }

        // Update YAML file on the server
        async function updateYAML() {
            const formContainer = document.getElementById('formContainer');
            const formData = getFormData(formContainer);

            const response = await fetch('/update-input', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                alert((await response.json()).message);
            } else {
                alert("Failed to update YAML: " + (await response.json()).error);
            }
        }

        // Initial load of YAML data
        window.onload = loadYAML;
    </script>

    <style>
        body {
            margin-top: 2%;
            font-family: Arial, sans-serif;
            background-color: #e7f3ff;
            /* Light blue background */
            /* padding: 200px; */
            margin-left: 100px;
        }

        h1 {
            text-align: center;
            color: #004080;
            /* Darker blue for contrast */
        }

        #formContainer {
            width: 50%;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            /* White background for form */
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-label {
            font-weight: bold;
            margin-bottom: 5px;
            display: inline-block;
            color: #0056b3;
            /* Light blue text */
        }

        .form-input {
            width: 90%;
            padding: 8px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #99c2ff;
            /* Light blue border */
            border-radius: 4px;
        }

        .form-input-key {
            width: 25%;
            margin-right: 10px;
        }

        button {
            display: block;
            width: 150px;
            padding: 10px;
            margin: 0px auto;
            background-color: #007bff;
            /* Blue button */
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
            /* Darker blue on hover */
        }
    </style>

    <h1 style="margin-top: 50px;
    font-family: 'Poppins', sans-serif;
    font-size: 36px;
    font-weight: bold;
    color: #0545a0;">Client and Department Modification</h1>
    <div id="formContainer">
    </div>
    <button onclick="updateYAML()" style="align-items: center; margin-top: 10px; width: 20%; height: 10%;">Save
        Changes</button>
    </body>

</html>